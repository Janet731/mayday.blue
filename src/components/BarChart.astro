---
const { stat = 'Welcome, world!' } = Astro.props;
---

<bar-chart data-stat={stat}>
  <canvas />
</bar-chart>

<script>
  import Chart from 'chart.js/auto'
  import 'chartjs-adapter-date-fns'

  class BarChart extends HTMLElement {
    constructor() {
      super();

      const stat = this.dataset.stat
      if (!stat) {
        return
      }
      const dateList = stat.split(',')
      const parsedData: { x: string, y: number }[] = []
      dateList.forEach((date) => {
        const found = parsedData.find((item) => item.x === date)
        if (found) {
          found.y += 1
        } else {
          parsedData.push({ x: date, y: 1 })
        }
      })
      const ctx = this.querySelector('canvas') as HTMLCanvasElement
      new Chart(ctx, {
        type: 'bar',
        options: {
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              enabled: false,
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'month',
                // parser: 'yyyy-MM-dd',
                displayFormats: {
                  month: 'yyyy-MM'
                }
              },
            },
          },
        },
        data: {
          datasets: [{
            label: '点歌次数',
            data: parsedData,
          }]
        },
      })
    }
  }
  customElements.define('bar-chart', BarChart)
</script>